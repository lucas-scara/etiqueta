<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Requisição / Impressão (A4)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">

  <style>
    :root{
      --bg:#f7f7f9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --primary:#2563eb; --radius:12px; --shadow:0 6px 20px rgba(0,0,0,.06); --w:1280px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
    }
    .header{ max-width:var(--w); margin:18px auto 8px; padding:0 16px; display:flex; justify-content:space-between; align-items:center; }
    .header h1{font-size:18px;margin:0;font-weight:600}

    .container{max-width:var(--w); margin:0 auto 20px; padding:0 16px}
    .grid{ display:grid; gap:16px; grid-template-columns:1fr; }
    @media(min-width:980px){ .grid{ grid-template-columns:1fr 2fr; } }

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px; display:flex; flex-direction:column; gap:14px;
      min-height:320px;
    }
    .field{display:flex; flex-direction:column; gap:8px}
    label{font-size:14px; color:#374151; font-weight:600}
    select, input[type=text], textarea, input[type=date], input[type=number]{
      width:100%; padding:12px; border:1px solid var(--border);
      border-radius:10px; font-size:14px; background:#fff; color:var(--text);
      outline:none; transition:border-color .15s, box-shadow .15s;
    }
    select:focus, input:focus, textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(37,99,235,.12); }
    textarea{min-height:92px; resize:vertical}
    .muted{font-size:12px;color:var(--muted)}

    /* segmented control */
    .seg{ display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; }
    .seg label{ margin:0; font-weight:500; cursor:pointer; user-select:none; }
    .seg input{display:none}
    .seg span{ display:inline-block; padding:8px 14px; transition: background .15s, color .15s; }
    .seg input:not(:checked)+span:hover{ background:#f3f4f6; }
    .seg input:checked+span{ background:var(--primary); color:#fff; }

    .actions{ display:flex; gap:10px; justify-content:center; align-items:center; position:sticky; bottom:0; padding:10px; backdrop-filter:blur(6px); }
    .btn{ padding:10px 16px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; font-size:14px; font-weight:600; transition:transform .05s, background .15s, border-color .15s; }
    .btn:hover{background:#f3f4f6}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .btn.primary:hover{background:#1d4ed8}

    /* painel de prévia */
    .preview{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:12px; position:sticky; top:12px;
      height:calc(100vh - 120px); min-height:520px;
      display:flex; flex-direction:column;
    }
    .panelTitle{ font-size:14px; font-weight:600; color:#374151; margin:2px 2px 8px; }
    .preview iframe{ width:100%; height:100%; border:0; border-radius:8px; background:#111; }

    /* Badge "Salvo" dentro da prévia */
    .saved{
      position:absolute; top:10px; left:12px; z-index:5;
      font-size:12px; color:var(--muted);
      background:rgba(255,255,255,.92); border:1px solid var(--border);
      padding:4px 10px; border-radius:999px; box-shadow:var(--shadow);
      opacity:0; transition:opacity .25s;
    }
    .saved.show{opacity:1}

    .row-inline{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row-inline .inline{display:flex; align-items:center; gap:8px}
    .hidden{display:none !important}
  </style>

  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>

  <div class="header">
    <h1>Requisição para impressão</h1>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Form (1/3) -->
      <div class="card" id="formCard">

        <div class="field">
          <label for="clinicaSel">Nome da clínica</label>
          <select id="clinicaSel">
            <option>HCB - Centro Cirúrgico</option>
            <option>HCB - Centro de Endoscopia</option>
          </select>
        </div>

        <div class="field">
          <label>Data</label>
          <div class="seg" role="tablist" aria-label="Escolha de data">
            <label><input type="radio" name="dataModo" id="dataHoje" checked><span>Hoje</span></label>
            <label><input type="radio" name="dataModo" id="dataOutra"><span>Outra data</span></label>
          </div>
          <input type="date" id="dataOutraVal" class="hidden" aria-label="Escolha a data">
        </div>

        <div class="field">
          <label for="medicoInp">Médico requisitante</label>
          <input type="text" id="medicoInp" placeholder="Ex.: Dr(a). Nome Sobrenome — CRM/UF 123456">
        </div>

        <div class="field">
          <label for="naturezaInp">Natureza do material</label>
          <textarea id="naturezaInp" placeholder="Ex.: Vesícula biliar, fragmento de mucosa, etc."></textarea>
          <div class="muted">Descreva sucintamente o material enviado.</div>
        </div>

        <div class="field">
          <label for="resumoInp">Resumo clínico</label>
          <textarea id="resumoInp" placeholder="Ex.: História clínica, hipótese diagnóstica..."></textarea>
        </div>

        <div class="field">
          <label>Nº de frascos</label>
          <div class="row-inline" role="group" aria-label="Número de frascos">
            <label class="inline"><input type="radio" name="frascos" value="1" id="fr1">1</label>
            <label class="inline"><input type="radio" name="frascos" value="2" id="fr2">2</label>
            <label class="inline"><input type="radio" name="frascos" value="3" id="fr3">3</label>
            <label class="inline"><input type="radio" name="frascos" value="4" id="fr4">4</label>
            <label class="inline"><input type="radio" name="frascos" value="outros" id="frOutros">Outros</label>
            <input class="hidden" type="number" id="frOutrosVal" min="1" step="1" placeholder="Qtd." style="width:120px">
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="btnPrint">Imprimir</button>
          <a class="btn" id="btnDownload" download="etiqueta.pdf">Baixar PDF</a>
        </div>
      </div>

      <!-- Preview (2/3) -->
      <div class="preview">
        <div class="panelTitle">Prévia</div>
        <div class="saved" id="saved">Salvo</div>
        <iframe id="preview"></iframe>
      </div>
    </div>
  </div>

<script>
(function(){
  const { PDFDocument, StandardFonts, rgb } = PDFLib;

  // imagem base
  const IMG_SRC='template.jpg', IMG_WIDTH=1240, IMG_HEIGHT=1755;
  // A4
  const PAGE_W=595, PAGE_H=842, SCALE=PAGE_W/IMG_WIDTH;

  const state={ blobUrl:null, saveTimer:null, imgBytes:null, debounceId:null };

  const $=s=>document.querySelector(s);
  const onlyDigits=s=>(s||'').replace(/\D+/g,'');

  // payload
  function getPayload(){
    const pick=(src)=>{ const m=src.match(/[?#&]d=([^&]+)/);
      if(!m) return null;
      try{ const b64=decodeURIComponent(m[1]); const json=decodeURIComponent(escape(atob(b64))); return JSON.parse(json); }
      catch(e){ return null; }
    };
    return pick(location.hash)||pick(location.search)||{};
  }

  // formatadores
  const dateDigits8=s=>{ const d=onlyDigits(s); return d.length>=8?d.slice(0,8):''; };
  function formatDNBoxes(s){ const d8=dateDigits8(s); if(!d8) return ''; const dd=d8.slice(0,2),mm=d8.slice(2,4),yy=d8.slice(4,8); return `${dd}     ${mm}   ${yy}`; }
  function formatPhone(s){ const d=onlyDigits(s); if(d.length<10) return s; const ddd=d.slice(0,2); const p1=d.length===10?d.slice(2,6):d.slice(2,7); const p2=d.length===10?d.slice(6):d.slice(7); return `(${ddd}) ${p1}-${p2}`; }
  function formatCPF(s){ const d=onlyDigits(s); if(d.length!==11) return s; return d.slice(0,3)+'.'+d.slice(3,6)+'.'+d.slice(6,9)+'-'+d.slice(9,11); }
  function formatDateBRFromInput(ymd){ const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd||''); return m?`${m[3]}/${m[2]}/${m[1]}`:''; }
  function todayBR(){ const d=new Date(); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }

  // coordenadas (px na imagem)
  const FIELDS_TL={
    clinica:{left:285, top:275, size:28},

    nome:{left:180, top:390, size:28, bold:true},
    dn:{left:356, top:443, size:28},
    telefone:{left:702, top:443, size:28},
    convenio:{left:235, top:500, size:28},
    cns:{left:790, top:500, size:28},
    cpf:{left:475, top:555, size:28},
    nomeMae:{left:275, top:602, size:28},

    medico:{left:325, top:665, size:24, wrapPx:820},     // novo
    natureza:{left:358, top:708, size:24, wrapPx:820},
    resumo:{left:295, top:815, size:24, wrapPx:820},
    diagnostico:{left:295, top:980, size:24, wrapPx:820},// novo
    dataColeta:{left:240, top:1130, size:24},

    // Sexo
    sexoF:{left:210, top:455, size:26, bold:true},
    sexoM:{left:264, top:454, size:26, bold:true},

    // Marcas "X" para Nº de frascos (na linha do CPF)
    fr1:{left:885, top:555, size:22, bold:true},
    fr2:{left:935, top:555, size:22, bold:true},
    fr3:{left:980, top:555, size:22, bold:true},
    fr4:{left:1025, top:555, size:22, bold:true},
    frOutrosNum:{left:1065, top:555, size:22},          // número digitado no sublinhado
    frOutrosBox:{left:1145, top:555, size:22, bold:true} // parêntese de "outros"
  };

  const TL=(l,t,s)=>({ x:l*SCALE, y:PAGE_H-(t*SCALE)-(s*SCALE) });

  // UI refs
  const selClinica=$('#clinicaSel');
  const rHoje=$('#dataHoje'), rOutra=$('#dataOutra'), inpOutraData=$('#dataOutraVal');
  const inpMedico=$('#medicoInp'), inpNatureza=$('#naturezaInp'), inpResumo=$('#resumoInp');
  const savedBadge=$('#saved');
  const rFrascos=document.querySelectorAll('input[name="frascos"]');
  const frOutros=$('#frOutros'), frOutrosVal=$('#frOutrosVal');

  function syncDataInputs(){
    const show=rOutra.checked;
    inpOutraData.classList.toggle('hidden',!show);
    if(show) setTimeout(()=>inpOutraData.showPicker?inpOutraData.showPicker():inpOutraData.focus(),60);
  }
  function syncFrascosInput(){
    const isOutros=frOutros.checked;
    frOutrosVal.classList.toggle('hidden',!isOutros);
    if(isOutros) frOutrosVal.focus();
  }

  // prefs
  const LS_KEY='etiqueta_prefs_ui_v3';
  function savePrefs(){
    const selectedRadio = [...rFrascos].find(r=>r.checked);
    const prefs={
      clinica:selClinica.value,
      dataModo:rHoje.checked?'hoje':'outra',
      outra:inpOutraData.value,
      medico:inpMedico.value,
      natureza:inpNatureza.value,
      resumo:inpResumo.value,
      frascos:selectedRadio?selectedRadio.value:'',
      frOutrosVal:frOutrosVal.value
    };
    try{ localStorage.setItem(LS_KEY, JSON.stringify(prefs)); }catch(_){}
    savedBadge.classList.add('show');
    clearTimeout(state.saveTimer);
    state.saveTimer=setTimeout(()=>savedBadge.classList.remove('show'),900);
  }
  (function loadPrefs(){
    try{
      const p=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
      if(p.clinica) selClinica.value=p.clinica;
      if(p.dataModo==='outra'){ rOutra.checked=true; rHoje.checked=false; }
      if(p.outra) inpOutraData.value=p.outra;
      if(p.medico) inpMedico.value=p.medico;
      if(p.natureza) inpNatureza.value=p.natureza;
      if(p.resumo) inpResumo.value=p.resumo;
      if(p.frascos){
        const rd=[...rFrascos].find(r=>r.value===p.frascos);
        if(rd) rd.checked=true;
      }
      if(p.frOutrosVal) frOutrosVal.value=p.frOutrosVal;
    }catch(_){}
    syncDataInputs(); syncFrascosInput();
  })();

  // pré-carrega o template
  async function ensureTemplateLoaded(){
    if(!state.imgBytes){
      const resp=await fetch(IMG_SRC,{cache:'reload'});
      state.imgBytes=await resp.arrayBuffer();
    }
  }

  // quebra de linha
  function drawWrapped(page, font, text, cfg){
    if(!text) return;
    const sizePt=(cfg.size||12)*SCALE;
    const {x,y}=TL(cfg.left,cfg.top,cfg.size||12);
    const maxW=(cfg.wrapPx||800)*SCALE;
    const words=String(text).split(/\s+/); const lines=[]; let line='';
    const width=t=>font.widthOfTextAtSize(t,sizePt);
    words.forEach(w=>{ const test=line?line+' '+w:w; if(width(test)<=maxW){ line=test; } else { if(line) lines.push(line); line=w; }});
    if(line) lines.push(line);
    const lh=sizePt*1.25;
    lines.forEach((ln,i)=>page.drawText(ln,{x, y:y-(i*lh), size:sizePt, font, color:rgb(0,0,0)}));
  }

  // render do PDF
  async function generate(){
    await ensureTemplateLoaded();

    const dados=getPayload();

    const pdfDoc=await PDFDocument.create();
    const page=pdfDoc.addPage([PAGE_W,PAGE_H]);

    const img=await pdfDoc.embedJpg(state.imgBytes);
    page.drawImage(img,{x:0,y:0,width:PAGE_W,height:IMG_HEIGHT*SCALE});

    const helv=await pdfDoc.embedFont(StandardFonts.Helvetica);
    const helvB=await pdfDoc.embedFont(StandardFonts.HelveticaBold);

    const nomeCompleto=[dados.nome||'',dados.sobrenome||''].join(' ').trim();
    const dnBoxes=formatDNBoxes(dados.nascimento||'');
    const tel=formatPhone(dados.celular||'');
    const conv='SUS';
    const cns=(dados.cns||'').trim();
    const cpf=formatCPF(dados.cpf||'');
    const mae=(dados.nomeMae||'').trim();
    const sexoRaw=(dados.sexo||'').toString().trim().toUpperCase();

    const clinica=selClinica.value;
    const medico=(inpMedico.value||'').trim();
    const natureza=(inpNatureza.value||'').trim();
    const resumo=(inpResumo.value||'').trim();
    const dataColeta=rHoje.checked?todayBR():formatDateBRFromInput(inpOutraData.value);

    const frSel=[...rFrascos].find(r=>r.checked)?.value||'';
    const frOutrosQtd=(frOutrosVal.value||'').trim();

    const VALUES={
      clinica, nome:nomeCompleto, dn:dnBoxes, telefone:tel, convenio:conv,
      cns, cpf, nomeMae:mae, dataColeta,
      sexoF:sexoRaw.startsWith('F')?'X':'',
      sexoM:sexoRaw.startsWith('M')?'X':''
    };

    // textos simples
    for(const [k,cfg] of Object.entries(FIELDS_TL)){
      if(['natureza','resumo','medico','diagnostico','fr1','fr2','fr3','fr4','frOutrosNum','frOutrosBox'].includes(k)) continue;
      const v=VALUES[k]; if(!v) continue;
      const sizePt=(cfg.size||12)*SCALE;
      const {x,y}=TL(cfg.left,cfg.top,cfg.size||12);
      page.drawText(String(v),{x,y,size:sizePt,font:cfg.bold?helvB:helv,color:rgb(0,0,0)});
    }

    // blocos com wrap
    drawWrapped(page, helv, medico,      FIELDS_TL.medico);
    drawWrapped(page, helv, natureza,    FIELDS_TL.natureza);
    drawWrapped(page, helv, resumo,      FIELDS_TL.resumo);
    drawWrapped(page, helv, (''),        {left:0,top:0,size:12}); // no-op
    drawWrapped(page, helv, ($('#diagInp')?.value||'').trim(), FIELDS_TL.diagnostico);

    // nº de frascos
    const markX=(pos)=>{ const cfg=FIELDS_TL[pos]; const sizePt=(cfg.size||22)*SCALE; const {x,y}=TL(cfg.left,cfg.top,cfg.size||22);
      page.drawText('X',{x,y,size:sizePt,font:helvB,color:rgb(0,0,0)});
    };
    if(frSel==='1') markX('fr1');
    else if(frSel==='2') markX('fr2');
    else if(frSel==='3') markX('fr3');
    else if(frSel==='4') markX('fr4');
    else if(frSel==='outros'){
      // número digitado e marca no parêntese
      if(frOutrosQtd){
        const cfg=FIELDS_TL.frOutrosNum; const sizePt=(cfg.size||22)*SCALE;
        const {x,y}=TL(cfg.left,cfg.top,cfg.size||22);
        page.drawText(String(frOutrosQtd),{x,y,size:sizePt,font:helv,color:rgb(0,0,0)});
      }
      markX('frOutrosBox');
    }

    if(state.blobUrl) URL.revokeObjectURL(state.blobUrl);
    const bytes=await pdfDoc.save();
    const blob=new Blob([bytes],{type:'application/pdf'});
    state.blobUrl=URL.createObjectURL(blob);
    $('#preview').src=state.blobUrl;
    $('#btnDownload').href=state.blobUrl;

    savePrefs();
  }

  // debounce
  const DEBOUNCE_MS=700;
  function scheduleGenerate(kind){
    if(kind==='typing'){ clearTimeout(state.debounceId); state.debounceId=setTimeout(()=>generate(),DEBOUNCE_MS); return; }
    clearTimeout(state.debounceId); generate();
  }

  // eventos
  const form=$('#formCard');
  form.addEventListener('input', e=>{
    const t=e.target.id;
    if(t==='naturezaInp'||t==='resumoInp'||t==='medicoInp'||t==='frOutrosVal'){ scheduleGenerate('typing'); }
  });
  form.addEventListener('change', e=>{
    const id=e.target.id;
    if(id==='clinicaSel'||id==='dataOutraVal'||id==='dataHoje'||id==='dataOutra'||id.startsWith('fr')){
      if(id==='dataHoje'||id==='dataOutra') syncDataInputs();
      if(id.startsWith('fr')) syncFrascosInput();
      scheduleGenerate('instant');
    }
  });

  // Diagnóstico clínico (textarea) – criar aqui para facilitar leitura do generate()
  const diagTA=document.createElement('textarea');
  diagTA.id='diagInp'; diagTA.className='hidden';
  document.body.appendChild(diagTA); // apenas para facilitar query; o valor vem do form abaixo
  // Troca pelo campo real:
  const diagField=document.createElement('div');
  diagField.className='field';
  diagField.innerHTML=`<label for="diagReal">Diagnóstico clínico</label>
                        <textarea id="diagReal" placeholder="Ex.: hipótese diagnóstica, achados prévios, etc."></textarea>`;
  document.getElementById('formCard').insertBefore(diagField, document.querySelector('.actions'));
  const diagReal=document.getElementById('diagReal');
  diagReal.addEventListener('input', ()=>{ diagTA.value=diagReal.value; scheduleGenerate('typing'); });

  // carregar preferências também para diagnóstico
  (function syncDiagFromLS(){
    try{
      const p=JSON.parse(localStorage.getItem('etiqueta_prefs_ui_v3')||'{}');
      if(p.diagnostico) { diagReal.value=p.diagnostico; diagTA.value=p.diagnostico; }
    }catch(_){}
  })();

  // salvar diagnóstico junto
  const oldSave=savePrefs;
  window.savePrefs=function(){
    const saved=JSON.parse(localStorage.getItem('etiqueta_prefs_ui_v3')||'{}');
    saved.diagnostico=diagReal.value||'';
    localStorage.setItem('etiqueta_prefs_ui_v3', JSON.stringify(saved));
    oldSave();
  };

  // inicial
  generate();
  window.addEventListener('hashchange', ()=>scheduleGenerate('instant'));

  // imprimir
  document.getElementById('btnPrint').onclick=()=>{
    const ifr=document.getElementById('preview');
    if(ifr&&ifr.contentWindow){ ifr.contentWindow.focus(); ifr.contentWindow.print(); }
  };
})();
</script>
</body>
</html>
