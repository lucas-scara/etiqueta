<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Etiqueta / Requisição (PDF)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <style>
    body{font-family:system-ui,Arial,Helvetica,sans-serif;margin:12px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .btn{padding:10px 14px;border:1px solid #dcdcdc;border-radius:8px;background:#f7f7f7;cursor:pointer}
    .btn:hover{background:#efefef}
    iframe{width:100%;height:80vh;border:1px solid #e6e6e6;border-radius:10px}
    details{margin:8px 0}
    pre{background:#f7f7f7;padding:10px;border-radius:8px;overflow:auto}
  </style>
  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body>

  <div class="bar">
    <button class="btn" id="btnGen">Gerar/Atualizar PDF</button>
    <button class="btn" id="btnPrint">Imprimir</button>
    <a class="btn" id="btnDownload" download="etiqueta.pdf">Baixar PDF</a>
    <button class="btn" id="btnToggleGrid" title="Grade de calibração">Grade</button>
  </div>
  <details>
    <summary>Debug (payload decodificado)</summary>
    <pre id="debug"></pre>
  </details>
  <iframe id="preview"></iframe>

<script>
(function(){
  const { PDFDocument, StandardFonts, rgb } = PDFLib;

  // --- Ajuste aqui se sua imagem tiver outro tamanho ---
  const IMG_SRC    = 'template.jpg';
  const IMG_WIDTH  = 1240;   // px
  const IMG_HEIGHT = 1755;   // px
  // -----------------------------------------------------

  const state = { blobUrl:null, showGrid:false };

  const $ = s => document.querySelector(s);
  const onlyDigits = s => (s||'').replace(/\D+/g,'');

  function getPayload(){
    const pick = (src) => {
      const m = src.match(/[?#&]d=([^&]+)/);
      if(!m) return null;
      try{
        const b64 = decodeURIComponent(m[1]);
        const json = decodeURIComponent(escape(atob(b64)));
        return JSON.parse(json);
      }catch(e){ console.error('Decode payload error:', e); return null; }
    };
    return pick(location.hash) || pick(location.search) || {};
  }

  function toDateBR(s){
    if(!s) return '';
    const m = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
    if(m) return `${m[1]}/${m[2]}/${m[3]}`;
    const d = onlyDigits(s);
    if(d.length===8) return `${d.slice(0,2)}/${d.slice(2,4)}/${d.slice(4,8)}`;
    const h = s.match(/^(\d{2}\/\d{2}\/\d{4})/);
    return h ? h[1] : s;
  }

  // Conversão de coordenadas: você já mediu como top/left a partir do canto superior esquerdo.
  // No PDF, a origem é no canto INFERIOR esquerdo. Convertemos com y = PAGE_H - top - fontSize.
  function TL(x_left, y_top, fontSize){ 
    return { x: x_left, y: IMG_HEIGHT - y_top - (fontSize||11) }; 
  }

  // MAPA DE CAMPOS nas coordenadas (top/left em px)
  // Já ajustados: top = top - 160
  const FONT_SIZE = 28;
  const FIELDS_TL = {
    nome:      { left:150, top:400 }, // antes 560
    dn:        { left:335, top:490 },            // antes 650
    telefone:  { left:690, top:490 },            // antes 650

    convenio:  { left:205, top:555 },            // antes 715
    cns:       { left:525, top:555 },            // antes 715

    cpf:       { left:525, top:610 },            // antes 770
    nomeMae:   { left:205, top:670 },            // antes 830
  };

  async function generate(){
    const dados = getPayload();
    $('#debug').textContent = JSON.stringify(dados,null,2);

    // 1) Cria doc e página do tamanho da imagem
    const pdfDoc = await PDFDocument.create();
    const page   = pdfDoc.addPage([IMG_WIDTH, IMG_HEIGHT]);

    // 2) Insere a imagem como "fundo"
    const imgBytes = await fetch(IMG_SRC + '?t=' + Date.now()).then(r=>r.arrayBuffer());
    let img;
    const type = IMG_SRC.split('.').pop().toLowerCase();
    if (type === 'png'){
      img = await pdfDoc.embedPng(imgBytes);
    } else {
      img = await pdfDoc.embedJpg(imgBytes);
    }
    page.drawImage(img, { x:0, y:0, width:IMG_WIDTH, height:IMG_HEIGHT });

    // 3) (Opcional) grade de calibração
    if (state.showGrid){
      const step=50;
      for(let x=0;x<=IMG_WIDTH;x+=step){
        page.drawLine({ start:{x, y:0}, end:{x, y:IMG_HEIGHT}, thickness:(x%100===0?0.8:0.3), color:rgb(0.7,0.7,1) });
      }
      for(let y=0;y<=IMG_HEIGHT;y+=step){
        page.drawLine({ start:{x:0, y}, end:{x:IMG_WIDTH, y}, thickness:(y%100===0?0.8:0.3), color:rgb(0.7,0.7,1) });
      }
    }

    // 4) Fontes
    const helv  = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const helvB = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

    // 5) Valores normalizados
    const nomeCompleto = [dados.nome||'', dados.sobrenome||''].join(' ').trim();
    const dn = toDateBR(dados.nascimento||'');
    const tel = (dados.celular||'').replace(/\s+/g,' ').trim();
    const conv = 'SUS';
    const cns = (dados.cns||'').trim();
    const cpf = (dados.cpf||'').trim();
    const mae = (dados.nomeMae||'').trim();

    const VALUES = {
      nome:     nomeCompleto,
      dn:       dn,
      telefone: tel,
      convenio: conv,
      cns:      cns,
      cpf:      cpf,
      nomeMae:  mae,
    };

    // 6) Desenha os textos
    Object.entries(FIELDS_TL).forEach(([key, cfg])=>{
      const value = VALUES[key];
      if(!value) return;
      const { x, y } = TL(cfg.left, cfg.top, cfg.size);
      page.drawText(String(value), {
        x, y,
        size: cfg.size || 12,
        font: cfg.bold ? helvB : helv,
        color: rgb(0,0,0)
      });
    });

    // 7) Salva e mostra no iframe
    if (state.blobUrl){ URL.revokeObjectURL(state.blobUrl); state.blobUrl=null; }
    const bytes = await pdfDoc.save();
    const blob = new Blob([bytes], { type:'application/pdf' });
    state.blobUrl = URL.createObjectURL(blob);
    $('#preview').src = state.blobUrl;
    $('#btnDownload').href = state.blobUrl;
  }

  // Inicializa e adiciona handlers
  generate();
  window.addEventListener('hashchange', generate);
  $('#btnGen').onclick = generate;
  $('#btnPrint').onclick = ()=> {
    const ifr = document.getElementById('preview');
    try { ifr.contentWindow.focus(); ifr.contentWindow.print(); }
    catch { window.open(state.blobUrl, '_blank', 'noopener'); }
  };
  $('#btnToggleGrid').onclick = ()=>{ state.showGrid = !state.showGrid; generate(); };
})();
</script>
</body>
</html>
