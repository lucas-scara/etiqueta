<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Etiqueta / Requisição</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <style>
    html,body{margin:0;padding:0}
    body{font-family: Arial, Helvetica, sans-serif;}

    /* Página no tamanho exato da sua imagem: 1240x1755 px */
    .page{
      position: relative;
      width: 1240px;
      height: 1755px;
      margin: 0 auto;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* **Fundo como IMG absoluta** (imprime sem depender de "gráficos de plano de fundo") */
    .bg{
      position:absolute; left:0; top:0;
      width:1240px; height:1755px;
      z-index:0;        /* atrás dos campos */
      display:block;
    }

    .field{
      position: absolute;
      font-size: 28px;
      color: #000;
      line-height: 1;
      white-space: nowrap;
      z-index:1;        /* acima do fundo */
    }

    /* ====== POSIÇÕES (origem: canto superior esquerdo) ====== */
    #nome      { left: 150px; top: 560px;  }
    #dn        { left: 335px; top: 650px;  } /* DD/MM/AAAA */
    #telefone  { left: 690px; top: 650px;  } /* (xx) xxxxx-xxxx */

    #convenio  { left: 205px; top: 715px;  } /* sempre "SUS" */
    #cns       { left: 525px; top: 715px;  } /* número da carteirinha (CNS) */

    #cpf       { left: 525px; top: 770px;  }
    #nomeMae   { left: 205px; top: 830px;  }

    .wrap{padding:10px}
    .bar{
      max-width:1240px;margin:10px auto;padding:8px 0;display:flex;gap:8px;justify-content:center;flex-wrap:wrap
    }
    .btn{padding:10px 14px;border:1px solid #dcdcdc;border-radius:8px;background:#f7f7f7;cursor:pointer}
    .btn:hover{background:#efefef}
    .hint{font-size:12px;color:#666;margin-top:4px;text-align:center}
    details{max-width:1240px;margin:0 auto 10px auto}
    pre{background:#f7f7f7;padding:10px;border-radius:8px;overflow:auto}

    @media print {
      .wrap, details { display:none !important; }
      .page{ margin:0 }
      /* margens zeradas para não cortar a imagem (ajuste se preferir) */
      @page { size: A4 portrait; margin: 0; }
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="bar">
      <button class="btn" id="btnPrint">Imprimir</button>
      <button class="btn" id="btnReload">Recarregar (forçar)</button>
    </div>
    <details>
      <summary>Debug (payload decodificado)</summary>
      <pre id="debug"></pre>
    </details>
    <div class="hint">
      Se algum texto ficar fora do lugar, ajuste os valores <code>left/top</code> no CSS.
      <br>Se o navegador ainda ocultar o fundo, marque “Imprimir gráficos de plano de fundo” nas opções de impressão (Chrome).
    </div>
  </div>

  <div class="page" id="page">
    <!-- IMAGEM DE FUNDO -->
    <img class="bg" id="bg" src="template.jpg" alt="template">

    <!-- CAMPOS -->
    <div id="nome"     class="field"></div>
    <div id="dn"       class="field"></div>
    <div id="telefone" class="field"></div>

    <div id="convenio" class="field"></div>
    <div id="cns"      class="field"></div>

    <div id="cpf"      class="field"></div>
    <div id="nomeMae"  class="field"></div>
  </div>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const onlyDigits = s => (s||'').replace(/\D+/g,'');

    function getPayload(){
      const pick = (src) => {
        const m = src.match(/[?#&]d=([^&]+)/);
        if(!m) return null;
        try{
          const b64 = decodeURIComponent(m[1]);
          const json = decodeURIComponent(escape(atob(b64)));
          return JSON.parse(json);
        }catch(e){ console.error('Decode payload error:', e); return null; }
      };
      return pick(location.hash) || pick(location.search) || {};
    }

    function toDateBR(s){
      if(!s) return '';
      const mm = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
      if(mm) return `${mm[1]}/${mm[2]}/${mm[3]}`;
      const d = onlyDigits(s);
      if(d.length===8) return `${d.slice(0,2)}/${d.slice(2,4)}/${d.slice(4,8)}`;
      const h = s.match(/^(\d{2}\/\d{2}\/\d{4})/);
      return h ? h[1] : s;
    }

    function render(){
      const dados = getPayload();
      $('#debug').textContent = JSON.stringify(dados, null, 2);

      const nomeCompleto = [dados.nome||'', dados.sobrenome||''].join(' ').trim();
      $('#nome').textContent = nomeCompleto;
      $('#dn').textContent = toDateBR(dados.nascimento||'');
      $('#telefone').textContent = (dados.celular||'').replace(/\s+/g,' ').trim();

      $('#convenio').textContent = 'SUS';
      $('#cns').textContent = (dados.cns||'').trim();
      $('#cpf').textContent = (dados.cpf||'').trim();
      $('#nomeMae').textContent = (dados.nomeMae||'').trim();
    }

    // primeira renderização
    render();
    window.addEventListener('hashchange', render);

    // ações
    $('#btnPrint').onclick = () => window.print();
    $('#btnReload').onclick = () => {
      const u = new URL(location.href);
      u.searchParams.set('t', Date.now());
      // recarrega garantindo que a IMG também seja rebaixada
      const img = document.getElementById('bg');
      img.src = 'template.jpg?t=' + Date.now();
      history.replaceState(null,'',u.toString());
    };
  })();
  </script>
</body>
</html>
